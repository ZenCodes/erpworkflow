<!-- Component import -->
<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../grn-service/grn-service.html">
<link rel="import" href="../dialog-page/dialog-page.html">
<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/demo-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="stylesheet" href="../../bower_components/paper-styles/demo.css">
<!-- Component registeration -->
<dom-module id="intent-service">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-button{
        text-align: center;      
        border-radius: 2px;
        box-shadow: rgba(0, 0, 0, 0.0980392) 5px 5px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 10px;
        background-color: #3d6868;
        color: white;
        height: 30px;
        margin-top: 1%;
        text-transform:none;
        margin-left: 3%;
      }
      .dialogdiv{
        @apply(--layout-vertical);
      }
      .innerdialog{
        @apply(--layout-horizontal);
      }
    </style>
   
  <!--Component which make request to display the Intent items based on INT no-->
    <iron-ajax
      id="intentstateupdateajax"
      url="{{intentupdateurl}}"
      params='{{intentupdateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="intentstateupdateResponse">
    </iron-ajax>

    <!-- Fetch role info for the intent items -->
    <iron-ajax
      id="promoteRolereadAjax"
      url="{{promoterolereadurl}}"
      params="{{promoteroleread}}"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPromoteRolereadResponse">
    </iron-ajax>

    <!--Component which make request to display the Intent items based on INT no-->
    <iron-ajax

      id="intentpoitemajax"
      url="{{intentpourl}}"
      params='{{intentpoparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnintentpoitemResponse">
    </iron-ajax>

     <!--Component to create po for the item-->
    <iron-ajax
      id="itempocreateajax"
      url="{{itempocreateurl}}"
      params='{{itempocreateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnitempocreateResponse">
    </iron-ajax>

     <!-- component to view the pocreated intentem it -->
    <iron-ajax
      id="viewintentpocreateajax"
      url="{{viewintentpocreateurl}}"
      params='{{viewintentpocreateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnviewintentpocreateResponse">
    </iron-ajax>

    <!-- Component to promote the intent -->
    <iron-ajax
      id="viewintentpromoteajax"
      url="{{viewintentpromoteurl}}"
      params='{{viewintentpromoteparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnviewintentpromoteResponse">
    </iron-ajax>

    <!-- Component to update the po sequence no -->
    <iron-ajax
      id="posequpdateajax"
      url="{{posequpdateurl}}"
      params='{{posequpdateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnposequpdateResponse">
    </iron-ajax>

    <!-- Comonent which fetching the intent items based on the type -->
    <iron-ajax
      id="intenttypelistajax"
      url="{{intenttypelisturl}}"
      params='{{intenttypelistparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnintenttypelistResponse">
    </iron-ajax>

    <iron-ajax
      id="purchaseorderajax"
      url="{{purchaseorderurl}}"
      params='{{purchaseorderparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderResponse">
    </iron-ajax>

    <!-- Function which fetching the item info for creating po -->
    <iron-ajax
      id="purchaseorderitemajax"
      url="{{purchaseorderitemurl}}"
      params='{{purchaseorderitemparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitemResponse">
    </iron-ajax>

    <!-- Component which read the tax component for the item -->
    <iron-ajax
      id="purchaseorderitemtaxajax"
      url="{{purchaseorderitemtaxurl}}"
      params='{{purchaseorderitemtaxparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitemtaxResponse">
    </iron-ajax>

    <!-- Component which fetches the item price while creating po for the intnt item -->
    <iron-ajax
      id="purchaseorderitempriceajax"
      url="{{purchaseorderitempriceurl}}"
      params='{{purchaseorderitempriceparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitempriceResponse">
    </iron-ajax>


    <iron-ajax
      id="purchaseorderajaxmail"
      url="{{purchaseorderurlmail}}"
      params='{{purchaseorderparammail}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderResponsemail">
    </iron-ajax>

    <!-- Function which fetching the item info for creating po -->
    <iron-ajax
      id="purchaseorderitemajaxmail"
      url="{{purchaseorderitemurlmail}}"
      params='{{purchaseorderitemparammail}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitemResponsemail">
    </iron-ajax>

    <!-- Component which read the tax component for the item -->
    <iron-ajax
      id="purchaseorderitemtaxajaxmail"
      url="{{purchaseorderitemtaxurlmail}}"
      params='{{purchaseorderitemtaxparammail}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitemtaxResponsemail">
    </iron-ajax>

    <!-- Component which fetches the item price while creating po for the intnt item -->
    <iron-ajax
      id="purchaseorderitempriceajaxmail"
      url="{{purchaseorderitempriceurlmail}}"
      params='{{purchaseorderitempriceparammail}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPurchaseorderitempriceResponsemail">
    </iron-ajax>

    <iron-ajax
      id="purchaseordersendmailajax"
      url="{{purchaseordersendmailurl}}"
      params='{{purchaseordersendmailparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnpurchaseordersendmailResponse">
    </iron-ajax>

    <!-- Component to fetch the company profile for PO creation -->
    <iron-ajax      
      id="companyprofilereadAjax"
      url="../../config/companyprofile.json"
      handle-as="json"
      content-type="application/json"
      on-response="companyprofilereadResponse">
    </iron-ajax>

    <iron-ajax
      id="intentsupplyajax"
      url="{{intentsupplyurl}}"
      params='{{intentsupplyparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="intentsupplyResponse">
    </iron-ajax>

    <grn-service id="gs"></grn-service>

    <div><dialog-page id="ID_Show_Dialog"></dialog-page></div>
  </template>
  
  <script>
  (function() {
    'use strict';
    var productid="";
    var intentno;
    var promotestate;
    var no=0;
    var arrlength=0;
    var poarray=[];
    var largestpono=0;
    var poarr=[];
    var poitemarr=[];
    var poitemtax=[];
    var poitemprice=[];
    var cmparr=[];
    Polymer({
      is: 'intent-service',
      ready:function(){
        this.flag=0;
      },
      // Function which make request to call the item for PO creation 
      FnPurchaseorderService:function(){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderurl=sessionStorage.getItem("curr_sess_url")+"purchaseorder-service";
         this.purchaseorderparam=obj;
         this.$.purchaseorderajax.generateRequest(); 
      },
      FnPurchaseorderResponse:function(e){
          poarr=e.detail.response.itemarr;
         if(poarr.length>0){
         var d=new Date(poarr[0].PO_Date);         
         var y=d.getFullYear();
         var m=d.getMonth();
         var d=d.getDate();
         poarr[0].PO_Date=d+"/"+(m+1)+"/"+y;
         document.querySelector("purchaseorder-home").poarray=poarr;
         document.querySelector("purchaseorder-card").poarray=poarr;
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitemurl=sessionStorage.getItem("curr_sess_url")+"purchaseorderitem-service";
         this.purchaseorderitemparam=obj;
         this.$.purchaseorderitemajax.generateRequest();          
         }
      },
      FnPurchaseorderitemResponse:function(e){
         poitemarr=e.detail.response.itemarr;         
         if(poitemarr.length>0){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitemtaxurl=sessionStorage.getItem("curr_sess_url")+"purchaseorderitemtax-service";
         this.purchaseorderitemtaxparam=obj;
         this.$.purchaseorderitemtaxajax.generateRequest();          
         }
      },
      FnPurchaseorderitemtaxResponse:function(e){
         poitemtax=e.detail.response.itemarr;                 
         if(poitemtax.length>0){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitempriceurl=sessionStorage.getItem("curr_sess_url")+"purchaseorderitemprice-service";
         this.purchaseorderitempriceparam=obj;
         this.$.purchaseorderitempriceajax.generateRequest();          
         }
      },
      FnPurchaseorderitempriceResponse:function(e){
          poitemprice=e.detail.response.itemarr;
          if(poitemprice.length>0){          
          var tax1=((parseFloat(poitemtax[0].Excise_Duty))/100);
          var tax2=((parseFloat(poitemtax[0].VAT))/100);
          var tax3=((parseFloat(poitemtax[0].CST))/100);
          var total=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(poitemarr[0].Quantity)).toFixed(2);          
          var exduty=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax1))*parseFloat(poitemarr[0].Quantity).toFixed(2);
          poitemarr[(poitemarr.length)-1].price=(poitemprice[0].Item_Supplier_price).toFixed(2);
          poitemarr[(poitemarr.length)-1].total=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(poitemarr[0].Quantity)).toFixed(2);
          poitemarr[(poitemarr.length)-1].exduty=((parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax1))*parseFloat(poitemarr[0].Quantity)).toFixed(2);

          if(poarr[0].State=="Tamilnadu"||poarr[0].State=="tamilnadu"||poarr[0].State=="Tamil nadu"||poarr[0].State=="tamil nadu"){
          poitemarr[(poitemarr.length)-1].vat=parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax2)*parseFloat(poitemarr[0].Quantity)).toFixed(2);
          poitemarr[(poitemarr.length)-1].cst=parseFloat("0").toFixed(2);
          poitemarr[(poitemarr.length)-1].grandtot=(parseFloat(total)+parseFloat(exduty)+parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*(parseFloat(tax2))*parseFloat(poitemarr[0].Quantity))).toFixed(2);
          }
          else{           
          poitemarr[(poitemarr.length)-1].vat=parseFloat("0").toFixed(2);
          poitemarr[(poitemarr.length)-1].cst=parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax3)*parseFloat(poitemarr[0].Quantity)).toFixed(2);          
          poitemarr[(poitemarr.length)-1].grandtot=(parseFloat(total)+parseFloat(exduty)+parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*(parseFloat(tax3))*parseFloat(poitemarr[0].Quantity))).toFixed(2);
          }
        }
          document.querySelector("purchaseorder-home").poitemarray=poitemarr;
          document.querySelector("purchaseorder-card").poitemarray=poitemarr;
      },
      // Selecting supplier to raise po for the intent item
      FnSelectSupplier:function(e){
        var selecteditem=e.target.selectedItem.textContent.trim();
        for(var i=0;i<this.suppliernamearr.length;i++){
          for(var j=0;j<this.suppliernamearr[i].suppliername.length;j++){
          if(selecteditem==this.suppliernamearr[i].suppliername[j].name)
            this.flag=1;
          }
        } 
        if(this.flag==1)
          alert('Po raised against the supplier'+selecteditem);
        else
          alert('Go with another supplier');      
      },
      // showing items for intent creation based on the logged user role
      FnIntentTypeListService:function(){
         var obj={"loggeduser":""};
         obj.loggeduser=sessionStorage.getItem("loggeduser");        
         this.intenttypelisturl=sessionStorage.getItem("curr_sess_url")+"intenttypelist-service";
         this.intenttypelistparam=obj;
         this.$.intenttypelistajax.generateRequest(); 
      },
      FnintenttypelistResponse:function(e){        
        document.querySelector('intent-page').FnSetIntentType(e.detail.response.itemarr);
      },
      // Function which read the item information for the po creation
      FnIntentPoItemRead:function(){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
         this.intentpourl=sessionStorage.getItem("curr_sess_url")+"intentpoitemread-service";
         this.intentpoparam=obj;
         this.$.intentpoitemajax.generateRequest();      
      },
      FnintentpoitemResponse:function(e){        
        document.querySelector('viewintentitemexpand-page').suppliernamearr=e.detail.response.itemarr;
        document.querySelector('viewintentitemexpand-page').FnShowSupplierDiv();
      },
      // Function which invoke while promoting intent state
      FnIntentStateUpdate:function(updatestate){        
        intentno=sessionStorage.getItem("sess_curr_intentregno");        
        promotestate=updatestate;
        this.intentupdateurl=sessionStorage.getItem("curr_sess_url")+"intentstateupdate-service";     
        var obj={"itemdes":"","intentregno":"","loggedrole":"","updatestate":"","createdby":"","createddate":""};
        obj.loggedrole=sessionStorage.getItem("loggedrole");
        obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
        obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
        obj.createdby=sessionStorage.getItem("loggeduser");
        var dt=new Date();
        var d = dt.getDate();
        var m = dt.getMonth();
        var y = dt.getFullYear();
        var dmy = d + "/" + (m+1) + "/" + y;          
        obj.createddate=dmy;
        obj.updatestate=updatestate;        
        this.intentupdateparam=obj;        
        this.$.intentstateupdateajax.generateRequest();
      } ,
      intentstateupdateResponse:function(e){        
        if(e.detail.response.returnval=="succ"){
          alert("done");
          this.promoterolereadurl=sessionStorage.getItem("curr_sess_url")+"promoteroleread-service";
          var obj={"intentno":""};
          obj.intentno=intentno;
          this.promoteroleread=obj;
          this.$.promoteRolereadAjax.generateRequest();
        }
        else
        {
          alert("not done");
        }
      },
      FnPromoteRolereadResponse:function(e){  
          var pstate;             
          var arr=e.detail.response.itemarr;          
          if(arr[0].state=="external"){
          if(promotestate=="Approved") 
           pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_PO;       
          else if(promotestate=="POCreated")          
           pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Accept;
          else if(promotestate=="POSent")          
           pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Accept;
          else if(promotestate=="Accepted")          
           pstate="Item Accepted!";
          }
          if(arr[0].state=="internal"){
          if(promotestate=="Approved")          
            pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Supply;
          else if(promotestate=="Supplied")          
            pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Accept;
          else if(promotestate=="Accepted")          
            pstate="Item Accepted!";
          }
          if(arr[0].state=="spot"){
            pstate="Item Approved!";
          }
          this.$.ID_Show_Dialog.FnShowDialog(pstate,"");
          this.$.gs.FnIntentitemReadService();
           
          if(promotestate!="POSent") { 
          document.querySelector('viewintentitem-page').setToggle();       
          window.location.href="../elements/indexhome.html";
          }
      },
      // Function which invokes to create po for the item based intent view
      FnCreatePO:function(supplier){
        var obj={"supplier":"","itemdes":"","intentregno":"","createdby":"","createddate":""};
        obj.supplier=supplier;
        obj.createdby=sessionStorage.getItem("loggeduser");

        obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
        obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
        this.itempocreateparam=obj;
        this.itempocreateurl=sessionStorage.getItem("curr_sess_url")+"itempocreate-service"
        this.$.itempocreateajax.generateRequest();
      },
      FnitempocreateResponse:function(e){        
        if(e.detail.response.itemarr=='succ')
          document.querySelector('viewintentitemexpand-page').FnSetPoRaiseFlag();
        else
          alert('Unable to craete PO!');
      },
      // Function which invokes to create po for the intent based intent view
      FnIntentViewPoCreateService:function(poarr){              
        poarray=poarr;
        arrlength=poarray.length; 
        this.viewintentpocreateurl=sessionStorage.getItem("curr_sess_url")+"viewintentpocreate-service";
        this.$.viewintentpocreateajax.generateRequest();
      },
      FnviewintentpocreateResponse:function(e){
        var temparr=[];
        var group='65';
        var ponumber=parseInt(e.detail.response.itemarr.returnval)+1;
        largestpono=ponumber;
        var temppo;
        for(var i=0;i<poarray.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":"","ponumber":""};
          obj.itemdes=poarray[i].itemdes;
          obj.supplier=poarray[i].supplier;
          obj.intentregno=poarray[i].intentregno;
          obj.ponumber=ponumber+String.fromCharCode(group);
          group=parseInt(group)+1;
          temparr.push(obj);
          this.FnViewIntentPromoteService(temparr);
         }
      },
      // Funtion to promote intent items to the next state
      FnViewIntentPromoteService:function(temparr){         
         for(var i=0;i<temparr.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":"","":"ponumber","createdby":"","createddate":""};
          var dt=new Date();
          var d = dt.getDate();
          var m = dt.getMonth();
          var y = dt.getFullYear();
          var dmy = d + "/" + (m+1) + "/" + y;
          obj.createddate=dmy;
          obj.createdby=sessionStorage.getItem("loggeduser");          
          obj.itemdes=temparr[i].itemdes;
          obj.supplier=temparr[i].supplier;
          obj.intentregno=temparr[i].intentregno;
          obj.ponumber=temparr[i].ponumber;          
          this.viewintentpromoteurl=sessionStorage.getItem("curr_sess_url")+"viewintentpromote-service";
          this.viewintentpromoteparam=obj;         
          this.$.viewintentpromoteajax.generateRequest();
         }
      },
      FnviewintentpromoteResponse:function(e){        
        if(JSON.stringify(e.detail.response.itemarr=='succ'))
        {
        no=no+1;
        if(arrlength==no){
         var obj={"ponumber":largestpono};
         this.posequpdateurl=sessionStorage.getItem("curr_sess_url")+"posequpdate-service";
         this.posequpdateparam=obj;         
         this.$.posequpdateajax.generateRequest();        
        }
        }
        else
          alert('PO is not created succ!');
      },
      FnposequpdateResponse:function(e){        
        if(e.detail.response.itemarr=='succ'){
          alert("Po created!");
          window.location.href="../elements/indexhome.html";
        }
        else
          alert('PO not created!');
      },
      // Function which make request to call the item for PO creation 
      FnPurchaseorderServicemail:function(){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderurlmail=sessionStorage.getItem("curr_sess_url")+"purchaseorder-service";
         this.purchaseorderparammail=obj;
         this.$.purchaseorderajaxmail.generateRequest(); 
      },
      FnPurchaseorderResponsemail:function(e){
          poarr=e.detail.response.itemarr;
          // alert(JSON.stringify(poarr));
         if(poarr.length>0){
         var d=new Date(poarr[0].PO_Date);         
         var y=d.getFullYear();
         var m=d.getMonth();
         var d=d.getDate();
         poarr[0].PO_Date=d+"/"+(m+1)+"/"+y;
         // document.querySelector("purchaseorder-home").poarray=poarr;
         // document.querySelector("purchaseorder-card").poarray=poarr;
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitemurlmail=sessionStorage.getItem("curr_sess_url")+"purchaseorderitem-service";
         this.purchaseorderitemparammail=obj;
         this.$.purchaseorderitemajaxmail.generateRequest();          
         }
      },
      FnPurchaseorderitemResponsemail:function(e){
         poitemarr=e.detail.response.itemarr;
         // alert(JSON.stringify(poitemarr));         
         if(poitemarr.length>0){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitemtaxurlmail=sessionStorage.getItem("curr_sess_url")+"purchaseorderitemtax-service";
         this.purchaseorderitemtaxparammail=obj;
         this.$.purchaseorderitemtaxajaxmail.generateRequest();          
         }
      },
      FnPurchaseorderitemtaxResponsemail:function(e){
         poitemtax=e.detail.response.itemarr;
         // alert(JSON.stringify(poitemtax));                 
         if(poitemtax.length>0){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");       
         this.purchaseorderitempriceurlmail=sessionStorage.getItem("curr_sess_url")+"purchaseorderitemprice-service";
         this.purchaseorderitempriceparammail=obj;
         this.$.purchaseorderitempriceajaxmail.generateRequest();          
         }
      },
      FnPurchaseorderitempriceResponsemail:function(e){
          poitemprice=e.detail.response.itemarr;
          // alert(JSON.stringify(poitemprice));
          if(poitemprice.length>0){          
          var tax1=((parseFloat(poitemtax[0].Excise_Duty))/100);
          var tax2=((parseFloat(poitemtax[0].VAT))/100);
          var tax3=((parseFloat(poitemtax[0].CST))/100);
          var total=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(poitemarr[0].Quantity)).toFixed(2);          
          var exduty=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax1))*parseFloat(poitemarr[0].Quantity).toFixed(2);
          poitemarr[(poitemarr.length)-1].price=(poitemprice[0].Item_Supplier_price).toFixed(2);
          poitemarr[(poitemarr.length)-1].total=(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(poitemarr[0].Quantity)).toFixed(2);
          poitemarr[(poitemarr.length)-1].exduty=((parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax1))*parseFloat(poitemarr[0].Quantity)).toFixed(2);

          if(poarr[0].State=="Tamilnadu"||poarr[0].State=="tamilnadu"||poarr[0].State=="Tamil nadu"||poarr[0].State=="tamil nadu"){
          poitemarr[(poitemarr.length)-1].vat=parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax2)*parseFloat(poitemarr[0].Quantity)).toFixed(2);
          poitemarr[(poitemarr.length)-1].cst=parseFloat("0").toFixed(2);
          poitemarr[(poitemarr.length)-1].grandtot=(parseFloat(total)+parseFloat(exduty)+parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*(parseFloat(tax2))*parseFloat(poitemarr[0].Quantity))).toFixed(2);
          }
          else{           
          poitemarr[(poitemarr.length)-1].vat=parseFloat("0").toFixed(2);
          poitemarr[(poitemarr.length)-1].cst=parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*parseFloat(tax3)*parseFloat(poitemarr[0].Quantity)).toFixed(2);          
          poitemarr[(poitemarr.length)-1].grandtot=(parseFloat(total)+parseFloat(exduty)+parseFloat(parseFloat(poitemprice[0].Item_Supplier_price)*(parseFloat(tax3))*parseFloat(poitemarr[0].Quantity))).toFixed(2);
          }
        }
        this.$.companyprofilereadAjax.generateRequest();
      },
      companyprofilereadResponse:function(e){
        cmparr=e.detail.response;
        this.purchaseordersendmailService();
      },
      purchaseordersendmailService:function(){
        var obj={"total":"","exduty":"","vat":"","cst":"","grandtot":"","email":"","cmpname":"","cmpaddr1":"","cmpaddr2":"","cmpaddr3":"","cmpemail":"","cmpphone":"","ponumber":"","podate":"","suppliername":"","location":"","city":"","district":"","state":"","mobileno":"",
         "productid":"","quantity":"","qtymeasure":"","unit":"","unitmeasure":"","itemid":"","exciseduty":"","vat":"","cst":"",
         "itemsupplierprice":""
        };
        obj.cmpname=cmparr[0].name;
        obj.cmpaddr1=cmparr[0].addressline1;
        obj.cmpaddr2=cmparr[0].addressline2;
        obj.cmpaddr3=cmparr[0].addressline3;
        obj.cmpemail=cmparr[0].email;
        obj.cmpphone=cmparr[0].phoneno;
        obj.email=poarr[0].Email;
        obj.ponumber=poarr[0].PO_Number;
        obj.podate=poarr[0].PO_Date;
        obj.suppliername=poarr[0].Supplier_Name;
        obj.location=poarr[0].Location;
        obj.city=poarr[0].City;
        obj.district=poarr[0].District;
        obj.state=poarr[0].State;
        obj.mobileno=poarr[0].Mobileno;
        obj.productid=poitemarr[0].Product_ID;
        obj.quantity=poitemarr[0].Quantity;
        obj.qtymeasure=poitemarr[0].Quantity_Measure;
        obj.unit=poitemarr[0].unit;
        obj.unitmeasure=poitemarr[0].Unit_Measure;
        obj.total=poitemarr[0].total;
        obj.exduty=poitemarr[0].exduty;
        obj.vat=poitemarr[0].vat;
        obj.cst=poitemarr[0].cst;
        obj.grandtot=poitemarr[0].grandtot;
        obj.itemid=poitemtax[0].Item_ID;       
        obj.itemsupplierprice=poitemprice[0].Item_Supplier_price;

        this.purchaseordersendmailurl=sessionStorage.getItem("curr_sess_url")+"purchaseordersendmail-service";
        this.purchaseordersendmailparam=obj;
        this.$.purchaseordersendmailajax.generateRequest(); 
      },
      FnpurchaseordersendmailResponse:function(e){
        alert('PO Sent');
        // document.querySelector('viewintentitem-page').setToggle();       
        window.location.href="../elements/indexhome.html";
      },
      FnIntentSupplyService:function(){
        var obj={"itemid":"","intentregno":""};
        obj.itemid=sessionStorage.getItem("sess_curr_itemno"); 
        // alert(obj.itemid);     
        obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
        this.intentsupplyurl=sessionStorage.getItem("curr_sess_url")+"intentsupply-service";
        this.intentsupplyparam=obj;
        this.$.intentsupplyajax.generateRequest(); 
      },
      intentsupplyResponse:function(e){
        alert(e.detail.response);
      }
    });
  })();
  </script>
</dom-module>
