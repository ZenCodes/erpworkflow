<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../grn-service/grn-service.html">
<link rel="import" href="../dialog-page/dialog-page.html">

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/demo-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="stylesheet" href="../../bower_components/paper-styles/demo.css">

<dom-module id="intent-service">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-button{
        text-align: center;      
        border-radius: 2px;
        box-shadow: rgba(0, 0, 0, 0.0980392) 5px 5px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 10px;
        background-color: #3d6868;
        color: white;
        height: 30px;
        margin-top: 1%;
        text-transform:none;
        margin-left: 3%;
      }
      .dialogdiv{
        @apply(--layout-vertical);
      }
      .innerdialog{
        @apply(--layout-horizontal);
      }
    </style>

    <!--<div class="card">
    <paper-dialog id="Fn_PoItem_dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
    <div class="dialogdiv">
    <template is="dom-repeat" items="{{suppliernamearr}}" as="out">
    <div class="innerdialog">
    <paper-item>{{out.itemdes}}</paper-item>   
    <paper-dropdown-menu label="Select">
    <paper-menu class="dropdown-content" on-iron-select="FnSelectSupplier">
      <template is="dom-repeat" items="{{out.suppliername}}">
        <paper-item value="{{item.name}}" >{{item.name}}</paper-item>
      </template>
    </paper-menu>
    </paper-dropdown-menu>
    </div>  
    </template>
    </div>
    <paper-button dialog-dismiss autofocus on-click="FnClickOk">OK</paper-button>
    </paper-dialog>
    </div>-->
    
  <!--Component which make request to display the Intent items based on INT no-->
    <iron-ajax
      id="intentstateupdateajax"
      url="{{intentupdateurl}}"
      params='{{intentupdateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="intentstateupdateResponse">
    </iron-ajax>

    <!-- Fetch role info for the intent items -->
    <iron-ajax
      id="promoteRolereadAjax"
      url="{{promoterolereadurl}}"
      params="{{promoteroleread}}"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnPromoteRolereadResponse">
    </iron-ajax>

    <!--Component which make request to display the Intent items based on INT no-->
    <iron-ajax
      id="intentpoitemajax"
      url="{{intentpourl}}"
      params='{{intentpoparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnintentpoitemResponse">
    </iron-ajax>

     <!--Component to create po for the item-->
    <iron-ajax
      id="itempocreateajax"
      url="{{itempocreateurl}}"
      params='{{itempocreateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnitempocreateResponse">
    </iron-ajax>

     <iron-ajax
      id="viewintentpocreateajax"
      url="{{viewintentpocreateurl}}"
      params='{{viewintentpocreateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnviewintentpocreateResponse">
    </iron-ajax>


     <iron-ajax
      id="viewintentpromoteajax"
      url="{{viewintentpromoteurl}}"
      params='{{viewintentpromoteparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnviewintentpromoteResponse">
    </iron-ajax>

      <iron-ajax
      id="posequpdateajax"
      url="{{posequpdateurl}}"
      params='{{posequpdateparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="FnposequpdateResponse">
    </iron-ajax>

    <grn-service id="gs"></grn-service>

    <div><dialog-page id="ID_Show_Dialog"></dialog-page></div>
  </template>
  <script src="//ajax.googleapis.com/ajax/libs/dojo/1.6.3/dojo/dojo.xd.js"></script>
  <script>
  (function() {
    'use strict';
    var productid="";
    var intentno;
    var promotestate;
    var no=0;
    var arrlength=0;
    var poarray=[];
    var largestpono=0;
    Polymer({
      is: 'intent-service',
      ready:function(){
        this.flag=0;
      },
      FnSelectSupplier:function(e){
        //alert(e.target.selectedItem.textContent.trim());
        var selecteditem=e.target.selectedItem.textContent.trim();

        //alert(this.suppliernamearr[0].suppliername);

        for(var i=0;i<this.suppliernamearr.length;i++){
          for(var j=0;j<this.suppliernamearr[i].suppliername.length;j++){
          if(selecteditem==this.suppliernamearr[i].suppliername[j].name)
            this.flag=1;
          }
        } 
        if(this.flag==1)
          alert('Po raised against the supplier'+selecteditem);
        else
          alert('Go with another supplier');      

      },
      FnIntentPoItemRead:function(){
         var obj={"intentregno":"","itemdes":""};
         obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
         obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
         this.intentpourl=sessionStorage.getItem("curr_sess_url")+"intentpoitemread-service";
         this.intentpoparam=obj;
         this.$.intentpoitemajax.generateRequest();      
      },
      FnintentpoitemResponse:function(e){
        //alert(JSON.stringify(e.detail.response.itemarr));
        document.querySelector('viewintentitemexpand-page').suppliernamearr=e.detail.response.itemarr;
        //alert(document.querySelector('viewintentitemexpand-page').suppliernamearr);
        document.querySelector('viewintentitemexpand-page').FnShowSupplierDiv();
      },
   
      FnIntentStateUpdate:function(updatestate){
        alert(updatestate);
        intentno=sessionStorage.getItem("sess_curr_intentregno");
        //alert(intentno);
        promotestate=updatestate;
        this.intentupdateurl=sessionStorage.getItem("curr_sess_url")+"intentstateupdate-service";     
        var obj={"itemdes":"","intentregno":"","loggedrole":"","updatestate":""};
        obj.loggedrole=sessionStorage.getItem("loggedrole");
        obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
        obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
        obj.updatestate=updatestate;
        //obj.pono=pono;
        this.intentupdateparam=obj;
        //alert(JSON.stringify(obj));
        this.$.intentstateupdateajax.generateRequest();
      } ,
      intentstateupdateResponse:function(e){
        alert(JSON.stringify(e.detail.response));
        if(e.detail.response.returnval=="succ"){
          alert("done");
          this.promoterolereadurl=sessionStorage.getItem("curr_sess_url")+"promoteroleread-service";
          var obj={"intentno":""};
          obj.intentno=intentno;
          this.promoteroleread=obj;
          this.$.promoteRolereadAjax.generateRequest();
        }
        else
        {
          alert("not done");
        }
      },
      FnPromoteRolereadResponse:function(e){  
          var pstate;             
          var arr=e.detail.response.itemarr;
          //alert("Inward Register Note is created! Sent for the Approval with  "+arr[0].Intent_PO);
          if(arr[0].state=="external"){
          if(promotestate=="Approved") 
           pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_PO;       
          else if(promotestate=="POCreated")          
           pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Accept;
          else if(promotestate=="Accepted")          
           pstate="Item Accepted!";
          }
          if(arr[0].state=="internal"){
          if(promotestate=="Approved")          
            pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Supply;
          else if(promotestate=="Supplied")          
            pstate="Item Promoted! Sent for the Approval with  "+arr[0].Intent_Accept;
          else if(promotestate=="Accepted")          
            pstate="Item Accepted!";
          }
          this.$.ID_Show_Dialog.FnShowDialog(pstate,"");
          this.$.gs.FnIntentitemReadService();
          document.querySelector('viewintentitem-page').setToggle();
          //document.querySelector('drawermenu-card').FnSetRefereshPage();
          window.location.href="../elements/indexhome.html";
          //this.$.gs.FnIntentitemReadService();
          //document.querySelector('app-homepage').setPage('intenthome-page');
          //document.querySelector('intenthome-page').setPage('View Intent');
          //document.querySelector('viewintent-page').setState();
      },
      FnCreatePO:function(supplier){
        var obj={"supplier":"","itemdes":"","intentregno":""};
        obj.supplier=supplier;
        obj.intentregno=sessionStorage.getItem("sess_curr_intentregno");
        obj.itemdes=sessionStorage.getItem("sess_curr_itemdes");
        this.itempocreateparam=obj;
        this.itempocreateurl=sessionStorage.getItem("curr_sess_url")+"itempocreate-service"
        this.$.itempocreateajax.generateRequest();
      },
      FnitempocreateResponse:function(e){
        //alert(e.detail.response.itemarr);
        if(e.detail.response.itemarr=='succ')
          document.querySelector('viewintentitemexpand-page').FnSetPoRaiseFlag();
        else
          alert('Unable to craete PO!');
      },
      FnIntentViewPoCreateService:function(poarr){
              //alert(JSON.stringify(poarray));
        poarray=poarr;
        arrlength=poarray.length;
        /*for(var i=0;i<poarray.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":""};
          obj.itemdes=poarray[i].itemdes;
          obj.supplier=poarray[i].supplier;
          obj.intentregno=poarray[i].intentregno;
          this.viewintentpocreateparam=obj;
          this.viewintentpocreateurl=sessionStorage.getItem("curr_sess_url")+"viewintentpocreate-service";
          this.$.viewintentpocreateajax.generateRequest();
        }*/
        this.viewintentpocreateurl=sessionStorage.getItem("curr_sess_url")+"viewintentpocreate-service";
        this.$.viewintentpocreateajax.generateRequest();

      },
      FnviewintentpocreateResponse:function(e){
        var temparr=[];
        var group='65';
        var ponumber=parseInt(e.detail.response.itemarr.returnval)+1;
        largestpono=ponumber;
        var temppo;
        for(var i=0;i<poarray.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":"","ponumber":""};
          obj.itemdes=poarray[i].itemdes;
          obj.supplier=poarray[i].supplier;
          obj.intentregno=poarray[i].intentregno;
          if(i==0){
            //alert('first');
           obj.ponumber=ponumber+String.fromCharCode(group);
           temparr.push(obj);
           //ponumber=parseInt(ponumber)+1;
         }
         else
         {
          for(var j=0;j<temparr.length;j++){
            //alert(poarray[i].supplier+"  "+temparr[j].supplier);
            if(poarray[i].supplier!=temparr[j].supplier){
              //alert('sec uneq');
              //ponumber=parseInt(ponumber)+1;
              group=parseInt(group)+1;
              temppo=ponumber+String.fromCharCode(group);
              //alert(temppo);
              obj.ponumber=temppo;
            }
            else{
              //alert('sec eq');
              //alert(temparr[j].ponumber);
              obj.ponumber=temparr[j].ponumber;
              break;
            }
          }
              temparr.push(obj);
        }
        }
        //alert(JSON.stringify(temparr));
        /*for(var i=0;i<temparr.length;i++){
          if(parseInt(temparr[i].ponumber)>parseInt(largestpono))
            largestpono=parseInt(temparr[i].ponumber);
        }*/
        this.FnViewIntentPromoteService(temparr);
        //alert(JSON.stringify(temparr));

         /*for(var i=0;i<temparr.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":"","":"ponumber"};
          obj.itemdes=temparr[i].itemdes;
          obj.supplier=temparr[i].supplier;
          obj.intentregno=temparr[i].intentregno;
          obj.ponumber=temparr[i].ponumber;
          this.viewintentpromteurl=sessionStorage.getItem("curr_sess_url")+"viewintentpromote-service";
          this.viewintentpromteparam=obj;
          this.$.viewintentpromteajax.generateRequest();
         }*/
     
      },
      FnViewIntentPromoteService:function(temparr){
         //alert(JSON.stringify(temparr));
         for(var i=0;i<temparr.length;i++){
          var obj={"itemdes":"","supplier":"","intentregno":"","":"ponumber"};
          obj.itemdes=temparr[i].itemdes;
          obj.supplier=temparr[i].supplier;
          obj.intentregno=temparr[i].intentregno;
          obj.ponumber=temparr[i].ponumber;
          //alert(JSON.stringify(obj));
         this.viewintentpromoteurl=sessionStorage.getItem("curr_sess_url")+"viewintentpromote-service";
         this.viewintentpromoteparam=obj;
         //alert(this.$.viewintentpromteajax);
         this.$.viewintentpromoteajax.generateRequest();
         }
      },
      FnviewintentpromoteResponse:function(e){
        //alert(e.detail.response.itemarr);
        if(JSON.stringify(e.detail.response.itemarr=='succ'))
        {
        no=no+1;
        if(arrlength==no){
         var obj={"ponumber":largestpono};
         this.posequpdateurl=sessionStorage.getItem("curr_sess_url")+"posequpdate-service";
         this.posequpdateparam=obj;         
         this.$.posequpdateajax.generateRequest();        
        }
        }
        else
          alert('PO is not created succ!');
      },
      FnposequpdateResponse:function(e){
        alert(JSON.stringify(e.detail.response.itemarr));
        if(e.detail.response.itemarr=='succ')
          alert("Po created!");
        else
          alert('PO not created!');
      }
    });
  })();
  </script>
</dom-module>
