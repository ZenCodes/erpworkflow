<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.2.61/jspdf.debug.js"></script>
<script type="text/javascript" src="http://html2canvas.hertzen.com/build/html2canvas.js"></script>

<dom-module id="test-certificate">
  <template>
    <style>
      :host {
        display: block;
      }
      #tb1{
    position: relative;
    width: 450px;
    height: 150px;
    top:60px;
    left: 10px

      }
      #tb2{
        position: relative;
    width:850px;
    height:150px;
    top:100px;
    left: 10px 
      }
      .bbox{
    position: relative;
    width: 900px;
    height: 1100px;
    border: 1px solid grey;
    top:90px;
    left: 50px

      }
      tr{
        text-align: left;
      }
      table{
        border-collapse: collapse;
        border-color: grey;
      }
      .card{
        @apply(--layout-horizontal);
      }
      tr,th,h2,h3{
        color: grey;
      }
    </style>
    <!-- <paper-button on-click="click">PDF</paper-button> -->
    <div class="bbox" id='card'>
    <div id='canvas'>
    <div class="card">
    <div><img src="../../images/logo.jpg" height="100px" weight="100px"></div>
    <div style="margin-left: 20px;"><h2><center>Certificate of Conformance to Requirements for Welding Electrode</center></h2></div>
    </div>
  <br><br>
      <table id="tb1">
      <tr><th colspan="6">Product ID:</th><th>{{itemid}}</th><tr>
      <tr><th colspan="6">Batch No:</th><th>{{batchno}}</th><tr>
      <tr><th colspan="6">Classification:</th><th>E120T5-K4C H4</th></tr> 
      <tr><th colspan="6">Specifications</th><th>{{itemname}}</th></tr> 
      <tr><th colspan="6">Diameter Tested:</th><th>1/16, 3/32</th></tr> 
      <tr><th colspan="6">Date Tested:</th><th>{{testdate}}</th></tr> 
      <tr><th colspan="6">Date Generated:</th><th>8/20/2015</th></tr>
      </table>
<br><br><br><br><br><br><br>
      <table>
        <tr>
        <td>
        This is to certify that the product named above and supplied on the referenced order number is of the same classification, manufacturing process, and material requirements as the
        performed at that time and the material tested met all requirements. It was manufactured and supplied by the Quality System Program of Hobart Brothers, which meets the
        requirements of ISO 9001, ANSI/AWS A5.01, and other specification and Military requirements, as applicable. This document  supplies actual test results of non-specific inspection in
        conformance with the requirements of EN 10204, type 2.2 certification
        </td>
        </tr>
        <tr height="40px"></tr>
        <tr style="text-align: center;"><td>THE STEEL USED IN THIS LOT OF MATERIAL WAS MELTED AND MANUFACTURED IN THE U.S.A.</td></tr>
      </table>
<br><br>
      <h3><center>Mechanical Properties</center></h3>
<br>

    <table border="1" style="border-collapse: collapse;width: 100%">
    <tr height="40px">
    <template is="dom-repeat" items="{{mechanicTitle}}" as="item">
    <th style="text-align: center;">{{item.Property_Name}}</th>
    </template>
    </tr>
     <tr height="40px">
    <template is="dom-repeat" items="{{mechanicValue}}" as="item">
    <td style="text-align: center;">{{item}}</td>
    </template>
    </tr>
    </table>

<br><br>
      <h3><center>Chemical Analysis</center></h3>
<br>
    <table border="1" style="border-collapse: collapse;width: 100%;">
    <tr height="40px">
    <template is="dom-repeat" items="{{chemicTitle}}" as="item">
    <th style="text-align: center;">{{item.Property_Name}}</th>
    </template>
    </tr>
     <tr height="40px">
    <template is="dom-repeat" items="{{chemicValue}}" as="item">
    <td style="text-align: center;">{{item}}</td>
    </template>
    </tr>
    </table>
    
    </div>
    </div>
     <!--Fetch TC Info-->
    <iron-ajax
      auto
      id="fetchtcchemicinfoajax"
      url="{{fetchtcchemicinfourl}}"
      params='{{fetchtcchemicinfoparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="fetchtcchemicinfoResponse">
    </iron-ajax>

    <!--Fetch TC Info-->
    <iron-ajax
      id="fetchtcmechinfoajax"
      url="{{fetchtcmechinfourl}}"
      params='{{fetchtcmechinfoparam}}'
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="fetchtcmechinfoResponse">
    </iron-ajax>

    <!-- Component which make request to read the chemical parameters for the item -->
    <iron-ajax
      method="post"
      id="chemicalpropertyreadajax"
      url="{{chemicalpropertyreadurl}}"
      params="{{chemicalpropertyreadparam}}"
      handle-as="json"
      content-type="application/json"
      on-response="chemicalpropertyreadResponse">
    </iron-ajax>

    <!-- Component which make request to read the mechanical parameters for the item -->
    <iron-ajax
      method="post"
      id="mechanicalpropertyreadajax"
      url="{{mechanicalpropertyreadurl}}"
      params="{{mechanicalpropertyreadparam}}"
      handle-as="json"
      content-type="application/json"
      on-response="mechanicalpropertyreadResponse">
    </iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';
 var arrlength=0;
  var no=0;
  var tcmecharr=[];
  var tcchemicarr=[];
  var tcchemic=[];
  var tcmechanic=[];
  var mechtitle=[];
  var chemictitle=[];
  var mechvalue=[];
  var chemicvalue=[];
  var batchcount=0;
    Polymer({
      is: 'test-certificate',
      ready:function(){
        // alert('hi');
        this.Fnfetchtcchemicinfo(sessionStorage.getItem("curr_sess_batchno"),sessionStorage.getItem("curr_sess_containerid"));
      },
       click:function(){        
        // var porder="PO"+sessionStorage.getItem("sess_curr_intentregno");
         html2canvas(document.querySelector('#card'), {
            onrendered: function(canvas) {
                var imgData = canvas.toDataURL('image/jpeg');                
                $("#imgRes").attr("src", imgData);
                var doc = new jsPDF('p', 'mm');                
                doc.addImage(imgData, 'JPEG', 10, 8);
                doc.output('datauri');
            }
      });
      },
       Fnfetchtcchemicinfo:function(batchno,containerid){
        // alert(batchno+"  "+containerid);
      var obj={"batchno":"","containerid":""};
      obj.batchno=sessionStorage.getItem("curr_sess_batchno");
      obj.containerid=sessionStorage.getItem("curr_sess_containerid");
      // this.batchno=batchno;
      // this.containerid=containerid;
      this.fetchtcchemicinfourl=sessionStorage.getItem("curr_sess_url")+"fetchtcchemicinfo-service";
      this.fetchtcchemicinfoparam=obj;
      this.$.fetchtcchemicinfoajax.generateRequest();

    },
    fetchtcchemicinfoResponse:function(e){
      // alert('yes');
      tcchemicarr=e.detail.response;
      // alert(JSON.stringify(tcchemicarr));   
      this.itemid=tcchemicarr[0].Item_ID;
      document.querySelector('test-certificate').itemid=tcchemicarr[0].Item_ID;
      this.itemname=tcchemicarr[0].Item_Name;
      document.querySelector('test-certificate').itemname=tcchemicarr[0].Item_Name
      this.batchno=tcchemicarr[0].Batch_No;
      document.querySelector('test-certificate').batchno=tcchemicarr[0].Batch_No;
      this.testdate=tcchemicarr[0].Test_Date;
      document.querySelector('test-certificate').testdate=tcchemicarr[0].Test_Date;
      if(tcchemicarr.length>0)
      {
        this.Fnfetchtcmechinfo(sessionStorage.getItem("curr_sess_batchno"),sessionStorage.getItem("curr_sess_containerid"));
      }
      // alert(JSON.stringify(e.detail.response));      
    },
    Fnfetchtcmechinfo:function(batchno,containerid){
      var obj={"batchno":"","containerid":""};
      obj.batchno=batchno;
      obj.containerid=containerid;
      this.fetchtcmechinfourl=sessionStorage.getItem("curr_sess_url")+"fetchtcmechinfo-service";
      this.fetchtcmechinfoparam=obj;
      this.$.fetchtcmechinfoajax.generateRequest();
    },
    fetchtcmechinfoResponse:function(e){
      tcmecharr=e.detail.response;
      if(tcmecharr.length>0)
      {
        this.fetchtcchemic();
      }
      // alert(JSON.stringify(e.detail.response));      
    },
    fetchtcchemic:function(){
      this.chemicalpropertyreadurl=sessionStorage.getItem("curr_sess_url")+"chemicalpropertyread-service";
      // this.chemicalpropertyreadparam=obj;
      this.$.chemicalpropertyreadajax.generateRequest();
    },
    chemicalpropertyreadResponse:function(e){
      tcchemic=e.detail.response;
      // alert(JSON.stringify(tcchemic));
      if(tcchemic.length>0)
      {
        this.chemicTitle=tcchemic;
        this.fetchtcmechanic();
      }
    },
    fetchtcmechanic:function(){
      this.mechanicalpropertyreadurl=sessionStorage.getItem("curr_sess_url")+"mechanicalpropertyread-service";
      // this.mechanicalpropertyreadparam=obj;
      this.$.mechanicalpropertyreadajax.generateRequest();
    },
    mechanicalpropertyreadResponse:function(e){
      tcmechanic=e.detail.response;
      this.mechanicTitle=tcmechanic;
      // alert(JSON.stringify(tcmechanic));
      var k=0;

      for(var j=0;j<tcchemic.length;j++){
          var obj={};
          var flag=0;
          var temp="";
          for(var i=0;i<tcchemicarr.length;i++){ 

          // alert(tcchemicarr[i].Property_Name+"   "+tcchemic[j].Property_Name);                 
          if((tcchemicarr[i].Property_Name).trim()==(tcchemic[j].Property_Name).trim()){
            // alert('eq');
            obj['property'+(k+1)]=tcchemicarr[i].Property_Value;
            temp=tcchemicarr[i].Property_Value;
            flag=1;
          }
          // else
          //   obj['property'+(k+1)]="Nil";
        }
        if(flag==1)
          chemicvalue.push(temp);
        else
          chemicvalue.push("Nil");
      }


       for(var j=0;j<tcmechanic.length;j++){
          var obj={};
          var flag=0;
          var temp="";
          for(var i=0;i<tcmecharr.length;i++){  
          // alert(tcmecharr[i].Property_Name+"   "+tcmechanic[j].Property_Name);                  
          if((tcmecharr[i].Property_Name).trim()==(tcmechanic[j].Property_Name).trim()){
            // alert('eq');
            obj['property'+(k+1)]=tcmecharr[i].Property_Value;
            temp=tcmecharr[i].Property_Value;
            flag=1;
          }
          // else
          //   obj['property'+(k+1)]="Nil";
        }
        if(flag==1)
          mechvalue.push(temp);
        else
          mechvalue.push("Nil");
        // mechvalue.push(obj);
      }

      this.itemid=tcchemicarr[0].Item_ID;
      document.querySelector('test-certificate').itemid=tcchemicarr[0].Item_ID;
      this.itemname=tcchemicarr[0].Item_Name;
      document.querySelector('test-certificate').itemname=tcchemicarr[0].Item_Name
      this.batchno=tcchemicarr[0].Batch_No;
      document.querySelector('test-certificate').batchno=tcchemicarr[0].Batch_No;
      this.testdate=tcchemicarr[0].Test_Date;
      document.querySelector('test-certificate').testdate=tcchemicarr[0].Test_Date;

      this.chemicValue=chemicvalue;
      this.mechanicValue=mechvalue;

      // alert(document.querySelector('#card'));
      html2canvas(document.querySelector('#card'), {
            onrendered: function(canvas) {
                var imgData = canvas.toDataURL('image/jpeg');                
                $("#imgRes").attr("src", imgData);
                var doc = new jsPDF('p', 'mm');                
                doc.addImage(imgData, 'JPEG', 10, 8);
                doc.output('datauri');
            }
      });
      
      // alert(JSON.stringify(chemicvalue));
      // alert(JSON.stringify(mechvalue));
    }
    });
  })();
  </script>
</dom-module>
